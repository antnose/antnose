name: Modern GitHub Metrics
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-metrics:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Stats
        run: |
          # Clean and create directory
          rm -rf metrics
          mkdir -p metrics
          
          # Download stats from external services
          curl -s -o metrics/stats.svg "https://github-readme-stats.vercel.app/api?username=antnose&show_icons=true&theme=dark&bg_color=0D1117&title_color=58A6FF&text_color=C9D1D9&icon_color=58A6FF&hide_border=true&count_private=true"
          curl -s -o metrics/streak.svg "https://github-readme-streak-stats.herokuapp.com/?user=antnose&theme=dark&background=0D1117&border=30363D&stroke=30363D&ring=58A6FF&fire=FF6D00&currStreakNum=58A6FF&sideNums=58A6FF&currStreakLabel=58A6FF"
          curl -s -o metrics/languages.svg "https://github-readme-stats.vercel.app/api/top-langs/?username=antnose&layout=compact&theme=dark&bg_color=0D1117&title_color=58A6FF&text_color=C9D1D9&hide_border=true"

      - name: Create Simple Dashboard
        run: |
          cat > metrics/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>antnose GitHub Stats</title>
              <style>
                  body { background: #0D1117; color: #C9D1D9; font-family: sans-serif; padding: 2rem; }
                  .container { max-width: 1200px; margin: auto; }
                  h1 { color: #58A6FF; text-align: center; font-size: 2.5rem; }
                  .stats { display: flex; flex-wrap: wrap; gap: 2rem; justify-content: center; margin-top: 2rem; }
                  img { width: 100%; max-width: 400px; border-radius: 1rem; }
                  .card { background: #161B22; padding: 1.5rem; border-radius: 1rem; border: 1px solid #30363D; }
                  footer { text-align: center; margin-top: 2rem; color: #8B949E; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üìä antnose's GitHub Stats</h1>
                  <div class="stats">
                      <div class="card">
                          <h3>üî• Streak</h3>
                          <img src="streak.svg" alt="Streak">
                      </div>
                      <div class="card">
                          <h3>‚≠ê Stats</h3>
                          <img src="stats.svg" alt="Stats">
                      </div>
                      <div class="card">
                          <h3>üíª Languages</h3>
                          <img src="languages.svg" alt="Languages">
                      </div>
                  </div>
                  <footer>
                      <p>Updated: <span id="date"></span></p>
                  </footer>
              </div>
              <script>
                  document.getElementById('date').textContent = new Date().toLocaleString();
              </script>
          </body>
          </html>
          EOF

      - name: Commit and Push
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          
          # Add only metrics directory
          git add metrics/
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üìä Update GitHub stats [skip ci]"
            # Pull latest changes and push
            git pull --rebase origin main
            git push origin main
          fi
