name: Modern GitHub Metrics
on:
  schedule:
    - cron: "0 0 * * *"  # Daily at midnight UTC
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  update-metrics:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create metrics directory
        run: |
          mkdir -p metrics
          mkdir -p public

      - name: Generate Streak Stats
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          user: antnose
          template: classic
          base: ""
          config_timezone: America/New_York
          plugin_habits: yes
          plugin_habits_from: 200
          plugin_habits_days: 365
          plugin_habits_facts: yes
          plugin_habits_charts: yes
          plugin_isocalendar: yes
          plugin_isocalendar_duration: half-year
          filename: metrics/streak.svg

      - name: Generate GitHub Stats
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          user: antnose
          template: classic
          base: ""
          config_timezone: America/New_York
          plugin_stars: yes
          plugin_stars_limit: 4
          plugin_followup: yes
          plugin_introduction: yes
          plugin_introduction_title: yes
          plugin_achievements: yes
          plugin_achievements_secrets: yes
          plugin_achievements_display: compact
          filename: metrics/stats.svg

      - name: Generate Top Languages
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          user: antnose
          template: classic
          base: ""
          config_timezone: America/New_York
          plugin_languages: yes
          plugin_languages_limit: 8
          plugin_languages_threshold: 0.5%
          plugin_languages_colors: github
          plugin_languages_details: percentage
          plugin_languages_sections: most-used
          plugin_languages_analysis_timeout: 15
          filename: metrics/languages.svg

      - name: Create Modern Dashboard
        run: |
          # Create a beautiful, modern dashboard
          cat > metrics/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>antnose - GitHub Stats Dashboard</title>
              <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
              <style>
                  :root {
                      --primary: #58A6FF;
                      --primary-dark: #1F6FEB;
                      --accent: #8250DF;
                      --bg: #0D1117;
                      --card-bg: #161B22;
                      --text: #F0F6FC;
                      --text-muted: #8B949E;
                      --border: #30363D;
                      --success: #238636;
                      --gradient: linear-gradient(135deg, var(--primary), var(--accent));
                      --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                      --glow: 0 0 20px rgba(88, 166, 255, 0.2);
                      --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                  }
                  
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                      background: var(--bg);
                      color: var(--text);
                      min-height: 100vh;
                      padding: 2rem;
                      background-image: 
                          radial-gradient(circle at 10% 20%, rgba(88, 166, 255, 0.05) 0%, transparent 20%),
                          radial-gradient(circle at 90% 80%, rgba(130, 80, 223, 0.05) 0%, transparent 20%);
                  }
                  
                  .container {
                      max-width: 1400px;
                      margin: 0 auto;
                  }
                  
                  header {
                      text-align: center;
                      margin-bottom: 3rem;
                      animation: fadeIn 0.8s ease;
                  }
                  
                  h1 {
                      font-size: 3.5rem;
                      font-weight: 800;
                      background: var(--gradient);
                      -webkit-background-clip: text;
                      background-clip: text;
                      color: transparent;
                      margin-bottom: 1rem;
                      letter-spacing: -0.5px;
                  }
                  
                  .subtitle {
                      font-size: 1.2rem;
                      color: var(--text-muted);
                      max-width: 600px;
                      margin: 0 auto;
                      line-height: 1.6;
                  }
                  
                  .dashboard {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                      gap: 2rem;
                      margin-bottom: 3rem;
                  }
                  
                  .card {
                      background: var(--card-bg);
                      border-radius: 20px;
                      border: 1px solid var(--border);
                      padding: 2rem;
                      position: relative;
                      overflow: hidden;
                      opacity: 0;
                      transform: translateY(20px);
                      transition: var(--transition);
                      box-shadow: var(--shadow);
                  }
                  
                  .card:nth-child(1) {
                      animation: slideUp 0.6s ease 0.2s forwards;
                  }
                  
                  .card:nth-child(2) {
                      animation: slideUp 0.6s ease 0.4s forwards;
                  }
                  
                  .card:nth-child(3) {
                      animation: slideUp 0.6s ease 0.6s forwards;
                  }
                  
                  .card:hover {
                      transform: translateY(-10px);
                      border-color: var(--primary);
                      box-shadow: var(--shadow), var(--glow);
                  }
                  
                  .card::before {
                      content: '';
                      position: absolute;
                      top: 0;
                      left: 0;
                      right: 0;
                      height: 4px;
                      background: var(--gradient);
                      transform: scaleX(0);
                      transition: transform 0.4s ease;
                  }
                  
                  .card:hover::before {
                      transform: scaleX(1);
                  }
                  
                  .card-header {
                      display: flex;
                      align-items: center;
                      margin-bottom: 1.5rem;
                  }
                  
                  .card-icon {
                      width: 50px;
                      height: 50px;
                      background: rgba(88, 166, 255, 0.1);
                      border-radius: 12px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      margin-right: 1rem;
                  }
                  
                  .card-title {
                      font-size: 1.5rem;
                      font-weight: 600;
                  }
                  
                  .card-content {
                      border-radius: 12px;
                      overflow: hidden;
                      background: rgba(0, 0, 0, 0.1);
                      padding: 1rem;
                  }
                  
                  .stats-img {
                      width: 100%;
                      border-radius: 8px;
                      transition: transform 0.3s ease;
                  }
                  
                  .stats-img:hover {
                      transform: scale(1.02);
                  }
                  
                  .controls {
                      display: flex;
                      justify-content: center;
                      gap: 1rem;
                      margin: 2rem 0;
                  }
                  
                  .control-btn {
                      padding: 0.75rem 1.5rem;
                      background: var(--card-bg);
                      border: 1px solid var(--border);
                      border-radius: 50px;
                      color: var(--text);
                      font-weight: 500;
                      cursor: pointer;
                      transition: var(--transition);
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                  }
                  
                  .control-btn:hover {
                      background: var(--primary);
                      color: white;
                      border-color: var(--primary);
                  }
                  
                  .control-btn:active {
                      transform: scale(0.98);
                  }
                  
                  footer {
                      text-align: center;
                      margin-top: 3rem;
                      padding-top: 2rem;
                      border-top: 1px solid var(--border);
                      color: var(--text-muted);
                  }
                  
                  .live-indicator {
                      display: inline-flex;
                      align-items: center;
                      gap: 0.5rem;
                      margin-top: 1rem;
                  }
                  
                  .pulse-dot {
                      width: 8px;
                      height: 8px;
                      background: var(--success);
                      border-radius: 50%;
                      animation: pulse 2s infinite;
                  }
                  
                  @keyframes fadeIn {
                      from { opacity: 0; }
                      to { opacity: 1; }
                  }
                  
                  @keyframes slideUp {
                      to {
                          opacity: 1;
                          transform: translateY(0);
                      }
                  }
                  
                  @keyframes pulse {
                      0%, 100% { opacity: 1; }
                      50% { opacity: 0.5; }
                  }
                  
                  @keyframes float {
                      0%, 100% { transform: translateY(0); }
                      50% { transform: translateY(-10px); }
                  }
                  
                  @media (max-width: 768px) {
                      body {
                          padding: 1rem;
                      }
                      
                      h1 {
                          font-size: 2.5rem;
                      }
                      
                      .dashboard {
                          grid-template-columns: 1fr;
                          gap: 1.5rem;
                      }
                      
                      .card {
                          padding: 1.5rem;
                      }
                      
                      .controls {
                          flex-direction: column;
                          align-items: center;
                      }
                      
                      .control-btn {
                          width: 100%;
                          max-width: 300px;
                          justify-content: center;
                      }
                  }
                  
                  /* Error handling */
                  .error-message {
                      display: none;
                      background: rgba(218, 54, 51, 0.1);
                      border: 1px solid var(--danger);
                      border-radius: 8px;
                      padding: 1rem;
                      margin: 1rem 0;
                      color: var(--danger);
                  }
                  
                  .loading {
                      display: none;
                      text-align: center;
                      padding: 2rem;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>üöÄ antnose's GitHub Dashboard</h1>
                      <p class="subtitle">Real-time statistics with modern animations and interactive controls</p>
                  </header>
                  
                  <div class="controls">
                      <button class="control-btn" id="refreshBtn">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M23 4v6h-6"/>
                              <path d="M1 20v-6h6"/>
                              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                          </svg>
                          Refresh Dashboard
                      </button>
                      <button class="control-btn" id="toggleAnimations">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <circle cx="12" cy="12" r="10"/>
                              <polyline points="12 6 12 12 16 14"/>
                          </svg>
                          Toggle Animations
                      </button>
                  </div>
                  
                  <div class="dashboard">
                      <div class="card">
                          <div class="card-header">
                              <div class="card-icon">
                                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2">
                                      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                                  </svg>
                              </div>
                              <h2 class="card-title">GitHub Streak</h2>
                          </div>
                          <div class="card-content">
                              <img src="streak.svg" alt="GitHub Contribution Streak" class="stats-img" id="streakImg" loading="lazy">
                          </div>
                      </div>
                      
                      <div class="card">
                          <div class="card-header">
                              <div class="card-icon">
                                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2">
                                      <line x1="18" y1="20" x2="18" y2="10"/>
                                      <line x1="12" y1="20" x2="12" y2="4"/>
                                      <line x1="6" y1="20" x2="6" y2="14"/>
                                  </svg>
                              </div>
                              <h2 class="card-title">GitHub Stats</h2>
                          </div>
                          <div class="card-content">
                              <img src="stats.svg" alt="GitHub Statistics" class="stats-img" id="statsImg" loading="lazy">
                          </div>
                      </div>
                      
                      <div class="card">
                          <div class="card-header">
                              <div class="card-icon">
                                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2">
                                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                  </svg>
                              </div>
                              <h2 class="card-title">Top Languages</h2>
                          </div>
                          <div class="card-content">
                              <img src="languages.svg" alt="Top Programming Languages" class="stats-img" id="langImg" loading="lazy">
                          </div>
                      </div>
                  </div>
                  
                  <footer>
                      <p>Dashboard updates automatically every day ‚Ä¢ GitHub: <a href="https://github.com/antnose" style="color: var(--primary); text-decoration: none;">@antnose</a></p>
                      <div class="live-indicator">
                          <span class="pulse-dot"></span>
                          <span>Live ‚Ä¢ Last updated: <span id="updateTime"></span></span>
                      </div>
                  </footer>
              </div>
              
              <script>
                  // Initialize
                  document.addEventListener('DOMContentLoaded', function() {
                      // Set initial time
                      updateTime();
                      
                      // Refresh button
                      document.getElementById('refreshBtn').addEventListener('click', function() {
                          refreshDashboard();
                      });
                      
                      // Toggle animations
                      document.getElementById('toggleAnimations').addEventListener('click', function() {
                          const cards = document.querySelectorAll('.card');
                          cards.forEach(card => {
                              card.style.animation = card.style.animation ? '' : 'float 3s ease-in-out infinite';
                          });
                          
                          const btn = this;
                          btn.innerHTML = btn.innerHTML.includes('Disable') 
                              ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Enable Animations'
                              : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Disable Animations';
                      });
                      
                      // Image error handling
                      const images = ['streakImg', 'statsImg', 'langImg'];
                      images.forEach(id => {
                          const img = document.getElementById(id);
                          if (img) {
                              img.onerror = function() {
                                  this.style.display = 'none';
                                  const container = this.parentElement;
                                  const errorMsg = document.createElement('div');
                                  errorMsg.className = 'error-message';
                                  errorMsg.innerHTML = `
                                      <p>‚ö†Ô∏è Failed to load image. The dashboard will auto-refresh.</p>
                                      <p><small>Last attempt: ${new Date().toLocaleTimeString()}</small></p>
                                  `;
                                  errorMsg.style.display = 'block';
                                  container.appendChild(errorMsg);
                                  
                                  // Auto-retry in 5 seconds
                                  setTimeout(() => {
                                      this.src = this.src.split('?')[0] + '?retry=' + Date.now();
                                      errorMsg.remove();
                                      this.style.display = 'block';
                                  }, 5000);
                              };
                          }
                      });
                      
                      // Auto-refresh every hour
                      setInterval(() => {
                          updateTime();
                          refreshImages();
                      }, 3600000);
                      
                      // Add floating animation to cards
                      setTimeout(() => {
                          const cards = document.querySelectorAll('.card');
                          cards.forEach(card => {
                              card.style.animation = 'float 6s ease-in-out infinite';
                          });
                      }, 1000);
                  });
                  
                  // Update time function
                  function updateTime() {
                      const now = new Date();
                      const options = { 
                          month: 'short', 
                          day: 'numeric', 
                          year: 'numeric',
                          hour: '2-digit', 
                          minute: '2-digit',
                          second: '2-digit'
                      };
                      document.getElementById('updateTime').textContent = now.toLocaleDateString('en-US', options);
                  }
                  
                  // Refresh dashboard
                  function refreshDashboard() {
                      const btn = document.getElementById('refreshBtn');
                      const originalText = btn.innerHTML;
                      
                      btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Refreshing...';
                      btn.disabled = true;
                      
                      refreshImages();
                      
                      setTimeout(() => {
                          btn.innerHTML = originalText;
                          btn.disabled = false;
                          updateTime();
                          
                          // Show success notification
                          showNotification('‚úì Dashboard refreshed successfully!', 'success');
                      }, 1500);
                  }
                  
                  // Refresh images
                  function refreshImages() {
                      const images = ['streakImg', 'statsImg', 'langImg'];
                      images.forEach(id => {
                          const img = document.getElementById(id);
                          if (img) {
                              const src = img.src.split('?')[0];
                              img.src = src + '?t=' + Date.now();
                          }
                      });
                  }
                  
                  // Notification system
                  function showNotification(message, type) {
                      const notification = document.createElement('div');
                      notification.className = 'notification';
                      notification.innerHTML = message;
                      
                      notification.style.cssText = `
                          position: fixed;
                          top: 20px;
                          right: 20px;
                          background: ${type === 'success' ? 'var(--success)' : 'var(--primary)'};
                          color: white;
                          padding: 1rem 1.5rem;
                          border-radius: 10px;
                          box-shadow: var(--shadow);
                          z-index: 1000;
                          animation: slideIn 0.3s ease;
                      `;
                      
                      document.body.appendChild(notification);
                      
                      setTimeout(() => {
                          notification.style.animation = 'slideOut 0.3s ease';
                          setTimeout(() => notification.remove(), 300);
                      }, 3000);
                  }
                  
                  // Add notification animations
                  const style = document.createElement('style');
                  style.textContent = `
                      @keyframes slideIn {
                          from { transform: translateX(100%); opacity: 0; }
                          to { transform: translateX(0); opacity: 1; }
                      }
                      @keyframes slideOut {
                          from { transform: translateX(0); opacity: 1; }
                          to { transform: translateX(100%); opacity: 0; }
                      }
                  `;
                  document.head.appendChild(style);
              </script>
          </body>
          </html>
          EOF

      - name: Commit and Push Changes
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .
          git commit -m "üìä Update GitHub metrics - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push
