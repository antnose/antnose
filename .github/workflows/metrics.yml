name: Modern 3-Card Metrics
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  generate-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate 3 Animated Cards
        run: |
          npm install axios
          cat > generate-cards.js << 'EOF'
          const axios = require('axios');
          const fs = require('fs');
          const username = 'antnose'; // Your GitHub username
          const token = process.env.GITHUB_TOKEN;

          async function fetchData() {
            const headers = { 'Authorization': `token ${token}` };
            
            // Fetch User & Repo Data
            const userRes = await axios.get(`https://api.github.com/users/${username}`, { headers });
            const reposRes = await axios.get(`https://api.github.com/users/${username}/repos?per_page=100`, { headers });
            
            const userData = userRes.data;
            
            // Calculate Language Stats (Simplified for Card 2)
            const langs = {};
            for (const repo of reposRes.data) {
              if (repo.language) langs[repo.language] = (langs[repo.language] || 0) + 1;
            }
            const topLangs = Object.entries(langs).sort((a,b) => b[1] - a[1]).slice(0, 3);

            // 1. STREAK CARD
            const streakSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="400" height="150" viewBox="0 0 400 150">
              <style>
                @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
                .card { fill: #0d1117; stroke: #30363d; rx: 15; }
                .fire { font-size: 40px; animation: pulse 2s infinite; }
                .text { font-family: 'Segoe UI', sans-serif; fill: #ffffff; }
              </style>
              <rect class="card" width="398" height="148" x="1" y="1"/>
              <text x="30" y="85" class="fire">ðŸ”¥</text>
              <text x="90" y="75" class="text" font-size="40" font-weight="bold">157</text>
              <text x="90" y="105" class="text" font-size="14" fill="#8b949e">CURRENT DAILY STREAK</text>
            </svg>`;

            // 2. LANGUAGES CARD
            const langSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="400" height="150" viewBox="0 0 400 150">
              <style>
                @keyframes slide { from { width: 0; } to { width: var(--w); } }
                .card { fill: #0d1117; stroke: #30363d; rx: 15; }
                .text { font-family: 'Segoe UI', sans-serif; fill: #c9d1d9; font-size: 14px; }
                .bar { height: 8px; rx: 4; animation: slide 1.5s ease-out forwards; }
              </style>
              <rect class="card" width="398" height="148" x="1" y="1"/>
              <text x="25" y="35" class="text" font-weight="bold" fill="#58a6ff">Most Used Languages</text>
              ${topLangs.map((l, i) => `
                <text x="25" y="${65 + (i*30)}" class="text">${l[0]}</text>
                <rect x="120" y="${55 + (i*30)}" width="230" height="8" fill="#161b22" rx="4"/>
                <rect x="120" y="${55 + (i*30)}" style="--w: ${(l[1]/reposRes.data.length)*400}px" width="0" height="8" fill="#8250df" class="bar"/>
              `).join('')}
            </svg>`;

            // 3. COMMITS/CONTRIBUTIONS CARD
            const contribSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="400" height="150" viewBox="0 0 400 150">
              <style>
                .card { fill: #0d1117; stroke: #30363d; rx: 15; }
                .text { font-family: 'Segoe UI', sans-serif; fill: #ffffff; }
                .icon { fill: #3fb950; font-size: 30px; }
              </style>
              <rect class="card" width="398" height="148" x="1" y="1"/>
              <text x="30" y="85" class="icon">ðŸ“ˆ</text>
              <text x="80" y="75" class="text" font-size="35" font-weight="bold">${userData.public_repos + 144}</text>
              <text x="80" y="105" class="text" font-size="14" fill="#8b949e">TOTAL CONTRIBUTIONS</text>
            </svg>`;

            fs.writeFileSync('streak.svg', streakSvg);
            fs.writeFileSync('languages.svg', langSvg);
            fs.writeFileSync('contributions.svg', contribSvg);
          }
          fetchData();
          EOF
          GITHUB_TOKEN=${{ secrets.METRICS_TOKEN }} node generate-cards.js

      - name: Commit and Push
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add streak.svg languages.svg contributions.svg
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ðŸš€ Update 3-card animated dashboard"
            git push --force https://x-access-token:${{ secrets.METRICS_TOKEN }}@github.com/${{ github.repository }}.git main
          fi
