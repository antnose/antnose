name: Genuine Modern 4-Card Metrics
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  generate-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate 4 Animated Cards
        run: |
          npm install axios
          cat > generate-cards.js << 'EOF'
          const axios = require('axios');
          const fs = require('fs');
          const username = 'antnose';
          const token = process.env.GITHUB_TOKEN;

          async function fetchData() {
            const headers = { 'Authorization': `token ${token}` };
            
            // GraphQL Query for Genuine Streaks & Contributions
            const query = `
            query {
              user(login: "${username}") {
                contributionsCollection {
                  contributionCalendar {
                    totalContributions
                    weeks {
                      contributionDays {
                        contributionCount
                        date
                      }
                    }
                  }
                }
                repositories(first: 100, ownerAffiliations: OWNER) {
                  nodes {
                    primaryLanguage { name }
                  }
                }
              }
            }`;

            const res = await axios.post('https://api.github.com/graphql', { query }, { headers });
            const data = res.data.data.user;

            // --- CALCULATE GENUINE STREAKS ---
            const days = data.contributionsCollection.contributionCalendar.weeks
              .flatMap(w => w.contributionDays)
              .reverse();
            
            let currentStreak = 0;
            for (let day of days) {
              if (day.contributionCount > 0) currentStreak++;
              else if (currentStreak > 0) break;
            }

            let maxStreak = 0, tempStreak = 0;
            [...days].reverse().forEach(day => {
              if (day.contributionCount > 0) {
                tempStreak++;
                maxStreak = Math.max(maxStreak, tempStreak);
              } else {
                tempStreak = 0;
              }
            });

            // --- CALCULATE LANGUAGES ---
            const langMap = {};
            data.repositories.nodes.forEach(r => {
              if (r.primaryLanguage) langMap[r.primaryLanguage.name] = (langMap[r.primaryLanguage.name] || 0) + 1;
            });
            const topLangs = Object.entries(langMap).sort((a,b) => b[1] - a[1]).slice(0, 3);

            const commonStyle = `
              <style>
                .card { fill: #0d1117; stroke: #30363d; rx: 15; transition: all 0.3s ease; }
                .card:hover { stroke: #58a6ff; fill: #161b22; transform: translateY(-5px); }
                .text { font-family: 'Segoe UI', Tahoma, sans-serif; fill: #ffffff; }
                .label { fill: #8b949e; font-size: 12px; }
                @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                .animate { animation: fadeUp 0.6s ease forwards; }
              </style>
            `;

            const createCard = (content) => `<svg xmlns="http://www.w3.org/2000/svg" width="300" height="120" viewBox="0 0 300 120">${commonStyle}${content}</svg>`;

            // CARD 1: MAX STREAK
            fs.writeFileSync('max_streak.svg', createCard(`
              <rect class="card" width="298" height="118" x="1" y="1"/>
              <text x="20" y="40" class="text label animate">GENUINE MAX STREAK</text>
              <text x="20" y="85" class="text animate" font-size="40" font-weight="bold" fill="#f1e05a">${maxStreak} Days</text>
            `));

            // CARD 2: CURRENT STREAK
            fs.writeFileSync('current_streak.svg', createCard(`
              <rect class="card" width="298" height="118" x="1" y="1"/>
              <text x="20" y="40" class="text label animate">CURRENT STREAK</text>
              <text x="20" y="85" class="text animate" font-size="40" font-weight="bold" fill="#ff7b72">${currentStreak} Days</text>
            `));

            // CARD 3: TOP LANGUAGES
            fs.writeFileSync('languages.svg', createCard(`
              <rect class="card" width="298" height="118" x="1" y="1"/>
              <text x="20" y="30" class="text label animate">TOP LANGUAGES</text>
              ${topLangs.map((l, i) => `<text x="20" y="${55+(i*20)}" class="text animate" font-size="14" style="animation-delay:${i*0.1}s">â€¢ ${l[0]}</text>`).join('')}
            `));

            // CARD 4: CONTRIBUTIONS
            fs.writeFileSync('contributions.svg', createCard(`
              <rect class="card" width="298" height="118" x="1" y="1"/>
              <text x="20" y="40" class="text label animate">TOTAL CONTRIBUTIONS</text>
              <text x="20" y="85" class="text animate" font-size="40" font-weight="bold" fill="#7ee787">${data.contributionsCollection.contributionCalendar.totalContributions}</text>
            `));
          }
          fetchData();
          EOF
          GITHUB_TOKEN=${{ secrets.METRICS_TOKEN }} node generate-cards.js

      - name: Commit and Push
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add *.svg
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ðŸ’Ž Update genuine 4-card aesthetic dashboard"
            git push --force https://x-access-token:${{ secrets.METRICS_TOKEN }}@github.com/${{ github.repository }}.git main
          fi
