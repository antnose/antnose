name: Modern GitHub Metrics
on:
  schedule:
    - cron: "0 0 * * *" # Daily at midnight UTC
  workflow_dispatch: # Manual trigger
  push:
    branches: [main, master]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Folders
        run: mkdir -p metrics public

      - name: Generate Metrics (Detailed)
        uses: lowlighter/metrics@latest
        with:
          filename: github-metrics.svg
          token: ${{ secrets.METRICS_TOKEN }}
          user: antnose
          template: classic
          base: ""
          config_timezone: America/New_York
          plugin_achievements: yes
          plugin_achievements_secrets: yes
          plugin_achievements_threshold: C
          plugin_achievements_display: detailed
          plugin_habits: yes
          plugin_habits_from: 200
          plugin_habits_days: 365
          plugin_habits_facts: yes
          plugin_habits_charts: yes
          plugin_isocalendar: yes
          plugin_isocalendar_duration: full-year
          plugin_languages: yes
          plugin_languages_limit: 8
          plugin_languages_threshold: 0.5%
          plugin_languages_colors: github
          plugin_languages_details: percentage
          plugin_languages_analysis_timeout: 15
          plugin_languages_sections: most-used
          plugin_notable: yes
          plugin_people: yes
          plugin_stars: yes
          plugin_traffic: yes

      - name: Generate GitHub Stats Card
        # Replaced @latest with @master to fix resolution error
        uses: anuraghazra/github-readme-stats@master 
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          username: antnose
          hide: commits,prs,issues
          show_icons: true
          include_all_commits: true
          theme: modern
          bg_color: 0D1117
          title_color: 58A6FF
          text_color: C9D1D9
          icon_color: 58A6FF
          border_color: 30363D
          output: metrics/stats.svg

      - name: Generate Streak Stats
        # Replaced @latest with @v2 to fix resolution error
        uses: denvercoder1/github-readme-streak-stats@v2 
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          user: antnose
          theme: modern
          background: 0D1117
          dates: 58A6FF
          ring: 58A6FF
          fire: FF6D00
          currStreakNum: FFFFFF
          output: metrics/streak.svg

      - name: Generate Top Languages
        # Replaced @latest with @master to fix resolution error
        uses: anuraghazra/github-readme-stats@master
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          username: antnose
          hide: stars,commits,prs,issues,contribs
          layout: compact
          theme: modern
          bg_color: 0D1117
          title_color: 58A6FF
          text_color: C9D1D9
          border_color: 30363D
          langs_count: 8
          output: metrics/languages.svg

      - name: Create Modern Dashboard
        run: |
          # Copy all generated SVGs to public folder
          [ -f github-metrics.svg ] && cp github-metrics.svg public/
          [ -f metrics/stats.svg ] && cp metrics/stats.svg public/
          [ -f metrics/streak.svg ] && cp metrics/streak.svg public/
          [ -f metrics/languages.svg ] && cp metrics/languages.svg public/

          # Create modern dashboard HTML
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en" data-theme="dark">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>antnose - Modern GitHub Stats</title>
              <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
              <style>
                  @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
                  @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');
                  
                  :root {
                      --primary: #58A6FF;
                      --bg: #0D1117;
                      --card-bg: #161B22;
                      --text: #C9D1D9;
                      --text-muted: #8B949E;
                      --border: #30363D;
                      --success: #238636;
                      --gradient: linear-gradient(135deg, #58A6FF 0%, #8250DF 100%);
                      --shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
                      --glow: 0 0 20px rgba(88, 166, 255, 0.3);
                      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                  }
                  
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { font-family: 'Space Grotesk', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 2rem; }
                  .container { max-width: 1400px; margin: 0 auto; }
                  
                  .header { text-align: center; margin-bottom: 3rem; }
                  .header h1 { font-size: 3rem; background: var(--gradient); -webkit-background-clip: text; background-clip: text; color: transparent; margin-bottom: 0.5rem; }
                  .header p { color: var(--text-muted); font-size: 1.1rem; }

                  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; }
                  
                  .card { 
                      background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); 
                      padding: 1.5rem; transition: var(--transition); box-shadow: var(--shadow);
                  }
                  .card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: var(--glow); }
                  
                  .card-header { display: flex; align-items: center; margin-bottom: 1rem; gap: 1rem; }
                  .card-icon { width: 40px; height: 40px; background: rgba(88, 166, 255, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--primary); }
                  
                  .stats-image { width: 100%; border-radius: 10px; }
                  
                  .footer { text-align: center; margin-top: 4rem; color: var(--text-muted); border-top: 1px solid var(--border); padding-top: 2rem; }
                  .pulse { display: inline-block; width: 8px; height: 8px; background: var(--success); border-radius: 50%; margin-right: 8px; animation: pulse 2s infinite; }
                  
                  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
                  @media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr; } }
              </style>
          </head>
          <body>
              <div class="container">
                  <header class="header">
                      <h1><i class="fas fa-chart-line"></i> antnose Analytics</h1>
                      <p>GitHub contribution data and coding statistics</p>
                  </header>
                  
                  <div class="stats-grid">
                      <div class="card">
                          <div class="card-header"><div class="card-icon"><i class="fas fa-fire"></i></div><h3>Daily Streak</h3></div>
                          <img src="streak.svg" class="stats-image">
                      </div>
                      <div class="card">
                          <div class="card-header"><div class="card-icon"><i class="fas fa-code"></i></div><h3>Languages</h3></div>
                          <img src="languages.svg" class="stats-image">
                      </div>
                      <div class="card">
                          <div class="card-header"><div class="card-icon"><i class="fas fa-trophy"></i></div><h3>General Stats</h3></div>
                          <img src="stats.svg" class="stats-image">
                      </div>
                      <div class="card" style="grid-column: 1 / -1;">
                          <div class="card-header"><div class="card-icon"><i class="fas fa-terminal"></i></div><h3>Detailed Metrics Report</h3></div>
                          <img src="github-metrics.svg" class="stats-image">
                      </div>
                  </div>

                  <footer class="footer">
                      <div class="last-updated"><span class="pulse"></span> Last updated: <span id="date"></span></div>
                  </footer>
              </div>
              <script>document.getElementById('date').textContent = new Date().toLocaleString();</script>
          </body>
          </html>
          EOF

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v2
        with:
          path: ./public

  deploy:
    needs: generate-metrics
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3
